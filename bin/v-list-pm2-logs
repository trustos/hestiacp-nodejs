#!/bin/bash
# info: list PM2 logs for a user
# options: USER [LINES]
#
# example: v-list-pm2-logs admin 100
#
# This function retrieves the PM2 logs for all domains of a specific user

user=$1
lines=${2:-100}

echo "Step 1: Debugging information"
echo "User: $user"
echo "Lines: $lines"

# Function to run command as user
run_as_user() {
    sudo -u "$user" bash -c "$1"
}

echo "Step 2: Checking for NVM"
if [ -s "/home/$user/.nvm/nvm.sh" ]; then
    echo "Using NVM"
    nvm_prefix="export NVM_DIR=\"/home/$user/.nvm\" && [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\" &&"
else
    echo "Not using NVM"
    nvm_prefix=""
fi

echo "Step 3: Locating PM2"
pm2_path=$(run_as_user "which pm2")
echo "PM2 path: $pm2_path"

echo "Step 4: Listing PM2 processes"
pm2_list=$(run_as_user "${nvm_prefix} pm2 list")
echo "PM2 processes:"
echo "$pm2_list"

echo "Step 5: Getting PM2 logs"
logs=$(run_as_user "${nvm_prefix} pm2 logs --lines $lines --nostream --raw")
echo "PM2 logs:"
if [ -n "$logs" ]; then
    echo "$logs"
else
    echo "No PM2 logs available for user $user"
fi

echo "Script execution completed"
exit 0
