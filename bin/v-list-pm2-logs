#!/bin/bash
# info: list PM2 logs for a user
# options: USER [LINES]
#
# example: v-list-pm2-logs admin 100
#
# This function retrieves the PM2 logs for all domains of a specific user

user=$1
lines=${2:-100}

echo "Debugging information:"
echo "User: $user"
echo "Lines: $lines"

# Function to run command as user
run_as_user() {
    sudo -u "$user" bash -c "$1"
}

# Check if NVM is used
if [ -s "/home/$user/.nvm/nvm.sh" ]; then
    echo "Using NVM"
    nvm_prefix="export NVM_DIR=\"/home/$user/.nvm\" && [ -s \"\$NVM_DIR/nvm.sh\" ] && . \"\$NVM_DIR/nvm.sh\" &&"
else
    echo "Not using NVM"
    nvm_prefix=""
fi

# Locate PM2
pm2_path=$(run_as_user "which pm2")
echo "PM2 path: $pm2_path"

# List PM2 processes
echo "PM2 processes:"
run_as_user "${nvm_prefix} pm2 list"

# Get PM2 logs
echo "PM2 logs:"
logs=$(run_as_user "${nvm_prefix} pm2 logs --lines $lines --nostream --raw")

if [ -n "$logs" ]; then
    echo "$logs"
else
    echo "No PM2 logs available for user $user"
fi

exit 0
