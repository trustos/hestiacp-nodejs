#!/bin/bash
# info: install nvm and nodejs
# options: USER NODE_VERSION
#
# The script installs NVM and the specified Node.js version for a user

user=$1
node_version=$2

# Log function
log_message() {
    echo "$(date): $1" >> /var/log/hestia/nvm_nodejs_install.log
}

log_message "Starting installation for user $user, Node version $node_version"

# Install NVM if not already installed
if [ ! -s "/home/$user/.nvm/nvm.sh" ]; then
    log_message "Installing NVM"
    su - $user -c "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash"
    if [ $? -ne 0 ]; then
        log_message "Failed to install NVM"
        exit 1
    fi
    log_message "NVM installed successfully"
else
    log_message "NVM already installed"
fi

# Install and use the specified Node.js version
log_message "Installing Node.js $node_version"
su - $user -c "source ~/.nvm/nvm.sh && nvm install $node_version && nvm use $node_version"
if [ $? -ne 0 ]; then
    log_message "Failed to install or use Node.js $node_version"
    exit 1
fi

log_message "Node.js $node_version installed and set as active"
exit 0
